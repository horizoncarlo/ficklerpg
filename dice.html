<!-- Version 0.92 -->
<html>
<head>
    <title>Fickle RPG - Dice Roller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        /* Fickle logo dark green:      #2D7575 */
        /* Fickle rules header green:   #47B8B8 */
    
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: monospace;
            font-size: 16px;
            overflow-x: auto;
            overflow-y: scroll;
            background: linear-gradient(#2D7575 40%, black 100%);
        }
        
        button {
            font-size: 1em;
        }
        
        button:hover, input:hover {
            opacity: 0.75;
        }
        
        a, a:visited {
            text-decoration: underline;
        }
        
        a {
            color: #47B8B8;
        }
        
        a:visited {
            color: #2D7575;
        }
        
        input[type="checkbox"] {
            -ms-transform: scale(1.2);
            -moz-transform: scale(1.2);
            -webkit-transform: scale(1.2);
            -o-transform: scale(1.2);
            transform: scale(1.2);
        }
        
        .headerBox {
            position: fixed;
            top: 0;
            right: 0;
            padding: 5px 0 5px 0;
            text-align: center;
            font-size: 0.85em;
            color: #47B8B8;
            background-color: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid #000000;
            width: 100%;
        }
        
        .bottomLeftPanel, .bottomRightPanel {
            color: white;
            position: absolute;
            bottom: 15px;
        }
        
        .bottomLeftPanel {
            left: 15px;
        }
        
        .bottomRightPanel {
            right: 15px;
        }
        
        .successMessage, .flatMessage {
            color: white;
        }
        
        .successMessage {
            font-size: 2em;
        }
        
        .successNum {
            font-size: 2.2em;
            font-weight: bold;
            text-shadow: 0 0 10px green;
        }
        
        .promptHeader {
            background-color: #47B8B8;
            color: white;
            text-shadow: 1px 1px black;
            font-size: 2em;
            padding: 5px 5px 5px 15px;
            border: 1px solid black;
        }
        
        .centerBox, .promptBox, .shakingDiceWrap {
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translateX(-50%) translateY(-50%);
            -webkit-transform: translate(-50%,-50%);
            transform: translate(-50%,-50%);
        }
        
        .centerBox {
            min-width: 400px;
            max-width: calc(100% - 200px);
            background: rgba(0,0,0,0.75);
            padding: 50px 90px 80px 90px;
            border: 3px solid #47B8B8;
            border-radius: 200px;
        }
        
        .promptBox {
            width: 80%;
            max-width: 800px;
            vertical-align: middle;
            background-color: white;
            -webkit-box-shadow: 10px 10px 12px 0px rgba(0,0,0,0.5);
            -moz-box-shadow: 10px 10px 12px 0px rgba(0,0,0,0.5);
            box-shadow: 10px 10px 12px 0px rgba(0,0,0,0.5);
        }
        
        .promptContent {
            padding: 15px;
            border: 1px solid black;
            border-top: 0;
            min-height: 200px;
        }
        
        .rollPanel {
            width: 532px; /* 4 columns of 128px dice plus padding */
        }
        
        .shakingDiceWrap {
            text-align: center;
        }
        
        .shakingDice {
            animation: shake 2s;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        
        .stepNote {
            font-size: 0.5em;
            text-shadow: none;
        }
        
        .rollNote {
            color: white;
            padding: 0 0 0 25px;
            font-weight: bold;
            font-size: 2em;
        }
        
        .errorNote {
            font-weight: bold;
            font-size: 1.2em;
            color: #DD0000;
        }
        
        .medDropdown {
            font-size: 1.5em;
        }
        
        .bigDropdown {
            font-size: 1.8em;
            min-width: 125px;
        }
        
        /* Mobile slum bois */
        @media only screen and (max-width: 680px) {
            body {
                font-size: 14px;
            }
            
            .promptBox {
                width: 96%;
                max-width: none;
            }
            
            .promptHeader {
                font-size: 1.5em;
            }
            
            .centerBox {
                min-width: 0;
                max-width: none;
                width: 96%;
                padding: 15px 0 15px 0;
                border-radius: 0;
            }
            
            .rollPanel {
                width: auto;
            }
        }
    </style>
    
    <script type="text/javascript">
        // Better random number generator, all squished up and minified
        var MersenneTwister=function(t){null==t&&(t=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(t)};MersenneTwister.prototype.init_genrand=function(t){for(this.mt[0]=t>>>0,this.mti=1;this.mti<this.N;this.mti++){t=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&t)>>>16)<<16)+1812433253*(65535&t)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(t,i){var s,h,m;for(this.init_genrand(19650218),s=1,h=0,m=this.N>i?this.N:i;m;m--){var n=this.mt[s-1]^this.mt[s-1]>>>30;this.mt[s]=(this.mt[s]^(1664525*((4294901760&n)>>>16)<<16)+1664525*(65535&n))+t[h]+h,this.mt[s]>>>=0,h++,++s>=this.N&&(this.mt[0]=this.mt[this.N-1],s=1),h>=i&&(h=0)}for(m=this.N-1;m;m--){n=this.mt[s-1]^this.mt[s-1]>>>30;this.mt[s]=(this.mt[s]^(1566083941*((4294901760&n)>>>16)<<16)+1566083941*(65535&n))-s,this.mt[s]>>>=0,++s>=this.N&&(this.mt[0]=this.mt[this.N-1],s=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var t,i=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var s;for(this.mti==this.N+1&&this.init_genrand(5489),s=0;s<this.N-this.M;s++)t=this.mt[s]&this.UPPER_MASK|this.mt[s+1]&this.LOWER_MASK,this.mt[s]=this.mt[s+this.M]^t>>>1^i[1&t];for(;s<this.N-1;s++)t=this.mt[s]&this.UPPER_MASK|this.mt[s+1]&this.LOWER_MASK,this.mt[s]=this.mt[s+(this.M-this.N)]^t>>>1^i[1&t];t=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^t>>>1^i[1&t],this.mti=0}return t=this.mt[this.mti++],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,(t^=t>>>18)>>>0},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)};
        var rand = new MersenneTwister();
        var isMobile = false;
        var showHeader = true;
        var MAX_STEPS = 3;
        var DICE_CONFIG = {
            width: 128, // Desktop version, mobile is divided by 2
            height: 128, // Desktop version, mobile is divided by 2
            defaultFill: 'white',
            luckFill: '#FFEAC1',
            successOpacity: 1,
            failOpacity: 0.65,
        };
        /*
         * Steps to performing a resolution:
         * 0: Choose the count of dice
         * 1: Choose number of dice to allocate to Fickle
         * 2: Luck dice to Fickle or Flat
         * 3: Roll and results
         */
        var resolutionStep = 0;
        var useRemote = false;
        var totalDice, fickleDice, flatDice, luckFickle, difficulty, results;
        
        function D6() {
            return 1 + Math.floor(rand.random() * 6);
        }
        
        function remoteD6(count) {
            if (typeof count === 'undefined') {
                count = 1;
            }
            var url = 'https://www.random.org/integers/?num=' + count + '&min=1&max=6&col=1&base=10&format=plain&rnd=new';
            
            return new Promise(function(resolve, reject) {
                var xhttp = new XMLHttpRequest();
                xhttp.timeout = 5000;
                xhttp.onload = function(e) {
                    // Ensure we're ready and have a proper status and the amount of data coming back is realistic
                    // Since from testing a wrong param or down site can accidentally return the whole page
                    if (this.readyState === 4 && this.status >= 200 && this.status < 400) {
                        if (e.loaded <= 100) {
                            var asArray = xhttp.responseText.trim().split('\n');
                            
                            // Note the array will be strings and we need nums, so convert
                            for (var convert = 0; convert < asArray.length; convert++) {
                                if (!isNaN(parseInt(asArray[convert]))) {
                                    asArray[convert] = parseInt(asArray[convert]);
                                }
                            }
                            
                            if (asArray.length === count) {
                                resolve(asArray);
                            }
                            else {
                                reject('Error when using random.org. Re-roll with local instead!');
                            }
                        }
                        else {
                            reject('Error when using random.org. Re-roll with local instead!');
                        }
                    }
                };
                xhttp.ontimeout = function (error) {
                    reject('Request to random.org timed out. Re-roll with local instead!');
                };
                xhttp.onabort = xhttp.onerror = function(error) {
                    reject('Error when using random.org. Re-roll with local instead!');
                };
                xhttp.open("GET", url, true);
                xhttp.send();
            });
        }
        
        function alertAndUncheckRemote(message) {
            var resPanel = document.getElementById('rollPanel');
            if (resPanel) {
                resPanel.innerHTML = '<span class="errorNote">' + message + '</span>';
            }
            else {
                alert(message);
            }
            
            // Reset our flag and uncheck our checkbox
            useRemote = false;
            var checkbox = document.getElementById('useRemote');
            if (checkbox) {
                checkbox.checked = false;
            }
        }
        
        function init() {
            // Determine if we're on a mobile device
            isMobile = window.matchMedia("only screen and (max-width: 680px)").matches;
            
            // Show or hide the welcome message on desktop vs mobile
            if (!isMobile) {
                showHeaderMessage();
            }
            else {
                hideHeaderMessage();
            }
            
            // Setup our key listeners for easy use
            setupListeners();
            
            // Fresh setup
            restart(true);
            
            // Hide our header message after a lot of time
            setTimeout(function() {
                hideHeaderMessage();
            }, (10 * 60 * 1000));
        }
        
        /**
         * Setup and manage hotkeys for faster/easier use by people
         */
        function setupListeners() {
            window.addEventListener("keyup", function(e) {
                if (e && typeof e.key !== 'undefined') {
                    switch (e.key.toLowerCase()) {
                        case '0': chooseDice(0); break;
                        case '1': chooseDice(1); break;
                        case '2': chooseDice(2); break;
                        case '3': chooseDice(3); break;
                        case '4': chooseDice(4); break;
                        case '5': chooseDice(5); break;
                        case '6': chooseDice(6); break;
                        case '7': chooseDice(7); break;
                        case '8': chooseDice(8); break;
                        case '9': chooseDice(9); break;
                        case 'c': nextStep(); break; // Continue
                        case 'b': case 'backspace': prevStep(); break; // Back
                        case 'r': if (resolutionStep === 3) { rollItBaby(); } break;
                        case 'u': if (resolutionStep === 3) { underdogBonus(); } break;
                        case 'y': if (resolutionStep === 2) { chooseLuckFickle(true); } break;
                        case 'n': if (resolutionStep === 2) { chooseLuckFickle(false); } break;
                        case 'h': toggleHeaderMessage(); break;
                    }
                }
            });
        }
        
        function restart(firstRun) {
            // Only reset our total dice on a first run
            // Otherwise remember what the user chose in case it's a common roll
            if (firstRun) {
                totalDice = 5;
                fickleDice = 1;
                flatDice = totalDice - fickleDice;
                luckFickle = true;
            }
            difficulty = 5;
            results = {
                luckDice: -1,
                fickleDice: [],
                flatSuccesses: -1
            };
            changeStep(0);
        }
        
        function hideHeaderMessage() {
            showHeader = false;
            hideEle('headerMessage');
        }
        
        function showHeaderMessage() {
            showHeader = true;
            showEle('headerMessage');
        }
        
        function toggleHeaderMessage() {
            if (showHeader) {
                hideHeaderMessage();
            }
            else {
                showHeaderMessage();
            }
        }
        
        function hideAllPrompts() {
            hideEle('totalCount');
            hideEle('fickleCount');
            hideEle('luckChoice');
            hideEle('rollResults');
        }
        
        function hideEle(id) {
            var hideEle = document.getElementById(id);
            if (hideEle) {
                hideEle.style.display = 'none';
            }
        }
        
        function showEle(id, focusId, selectOption) {
            var showEle = document.getElementById(id);
            if (showEle) {
                showEle.style.display = 'block';
                
                // Focus an element if desired
                if (typeof focusId !== 'undefined') {
                    var focusEle = document.getElementById(focusId);
                    if (focusEle) {
                        focusEle.focus();
                    }
                    
                    // Reset a dropdown value if desired
                    if (typeof selectOption !== 'undefined') {
                        updateDropdown(focusId, selectOption);
                    }
                }
            }
        }
        
        /**
         * Dump the passed value into a span for the user to see
         */
        function outputVar(spanId, value) {
            var spanEle = document.getElementById(spanId);
            if (spanEle) {
                spanEle.innerHTML = value;
            }
        }
        
        /**
         * Apply the passed value to a dropdown with the matching ID
         */
        function updateDropdown(id, value) {
            var dropdownEle = document.getElementById(id);
            if (dropdownEle) {
                dropdownEle.value = value;
            }
        }
        
        /**
         * Get an integer value from a dropdown
         */
        function getDropdownNum(id, defaultVal) {
            var dropdown = document.getElementById(id);
            if (dropdown) {
                if (!isNaN(parseInt(dropdown.value))) {
                    return parseInt(dropdown.value);
                }
            }
            return defaultVal;
        }
        
        /**
         * Get a boolean value from a dropdown
         */
        function getDropdownBoolean(id, defaultVal) {
            var dropdown = document.getElementById(id);
            if (dropdown) {
                if (typeof dropdown.value === 'string') {
                    return dropdown.value === 'true';
                }
                else if (typeof dropdown.value === 'boolean') {
                    return dropdown.value;
                }
            }
            return defaultVal;
        }
        
        /**
         * Create an SVG image for the passed dice value
         * This will use the current 'difficulty' to also shade the dice if it's a failure
         * If marked as a Luck Dice a different color will be used
         * See DICE_CONFIG for tweaks to the size/colors/etc.
         */
        function makeDice(val, isLuck) {
            var width = DICE_CONFIG.width;
            var height = DICE_CONFIG.height;
            var fill = DICE_CONFIG.defaultFill;
            var fillOpacity = DICE_CONFIG.successOpacity;
            
            // Dim any failed dice
            if (val < (isLuck ? difficulty-1 : difficulty)) {
                fillOpacity = DICE_CONFIG.failOpacity;
            }
            
            // Color our Luck dice differently, just like the simulators!
            if (isLuck) {
                fill = DICE_CONFIG.luckFill;
            }
            
            // Reduce our image size for mobile
            if (isMobile) {
                width = Math.floor(width/2);
                height = Math.floor(height/2);
            }
            
            // Dice SVG images of 1-6 thanks to https://game-icons.net/
            var toReturn;
            switch (val) {
                case 1:
                    toReturn = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: ' + height + 'px; width: ' + width + 'px;"><g class="" transform="translate(0,0)" style="touch-action: none;"><path d="M74.5 36A38.5 38.5 0 0 0 36 74.5v363A38.5 38.5 0 0 0 74.5 476h363a38.5 38.5 0 0 0 38.5-38.5v-363A38.5 38.5 0 0 0 437.5 36h-363zM256 206a50 50 0 0 1 0 100 50 50 0 0 1 0-100z" fill="' + fill + '" fill-opacity="' + fillOpacity + '"></path></g></svg>';
                 break;
                case 2:
                    toReturn = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: ' + height + 'px; width: ' + width + 'px;"><g class="" transform="translate(0,0)" style="touch-action: none;"><path d="M74.5 36A38.5 38.5 0 0 0 36 74.5v363A38.5 38.5 0 0 0 74.5 476h363a38.5 38.5 0 0 0 38.5-38.5v-363A38.5 38.5 0 0 0 437.5 36h-363zm316.97 36.03A50 50 0 0 1 440 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm-268 268A50 50 0 0 1 172 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97z" fill="' + fill + '" fill-opacity="' + fillOpacity + '"></path></g></svg>'
                 break;
                case 3:
                    toReturn = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: ' + height + 'px; width: ' + width + 'px;"><g class="" transform="translate(0,0)" style="touch-action: none;"><path d="M74.5 36A38.5 38.5 0 0 0 36 74.5v363A38.5 38.5 0 0 0 74.5 476h363a38.5 38.5 0 0 0 38.5-38.5v-363A38.5 38.5 0 0 0 437.5 36h-363zm316.97 36.03A50 50 0 0 1 440 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zM256 206a50 50 0 0 1 0 100 50 50 0 0 1 0-100zM123.47 340.03A50 50 0 0 1 172 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97z" fill="' + fill + '" fill-opacity="' + fillOpacity + '"></path></g></svg>';
                 break;
                case 4:
                    toReturn = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: ' + height + 'px; width: ' + width + 'px;"><g class="" transform="translate(0,0)" style="touch-action: none;"><path d="M74.5 36A38.5 38.5 0 0 0 36 74.5v363A38.5 38.5 0 0 0 74.5 476h363a38.5 38.5 0 0 0 38.5-38.5v-363A38.5 38.5 0 0 0 437.5 36h-363zm48.97 36.03A50 50 0 0 1 172 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm268 0A50 50 0 0 1 440 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm-268 268A50 50 0 0 1 172 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm268 0A50 50 0 0 1 440 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97z" fill="' + fill + '" fill-opacity="' + fillOpacity + '"></path></g></svg>';
                 break;
                case 5:
                    toReturn = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: ' + height + 'px; width: ' + width + 'px;"><g class="" transform="translate(0,0)" style="touch-action: none;"><path d="M74.5 36A38.5 38.5 0 0 0 36 74.5v363A38.5 38.5 0 0 0 74.5 476h363a38.5 38.5 0 0 0 38.5-38.5v-363A38.5 38.5 0 0 0 437.5 36h-363zm48.97 36.03A50 50 0 0 1 172 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm268 0A50 50 0 0 1 440 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zM256 206a50 50 0 0 1 0 100 50 50 0 0 1 0-100zM123.47 340.03A50 50 0 0 1 172 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm268 0A50 50 0 0 1 440 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97z" fill="' + fill + '" fill-opacity="' + fillOpacity + '"></path></g></svg>';
                 break;
                case 6:
                    toReturn = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: ' + height + 'px; width: ' + width + 'px;"><g class="" transform="translate(0,0)" style="touch-action: none;"><path d="M74.5 36A38.5 38.5 0 0 0 36 74.5v363A38.5 38.5 0 0 0 74.5 476h363a38.5 38.5 0 0 0 38.5-38.5v-363A38.5 38.5 0 0 0 437.5 36h-363zm48.97 36.03A50 50 0 0 1 172 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm268 0A50 50 0 0 1 440 122a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zM122 206a50 50 0 0 1 0 100 50 50 0 0 1 0-100zm268 0a50 50 0 0 1 0 100 50 50 0 0 1 0-100zM123.47 340.03A50 50 0 0 1 172 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97zm268 0A50 50 0 0 1 440 390a50 50 0 0 1-100 0 50 50 0 0 1 51.47-49.97z" fill="' + fill + '" fill-opacity="' + fillOpacity + '"></path></g></svg>';
                 break;
            }
            
            return toReturn;
        }
        
        function chooseDice(num) {
            if (typeof num !== 'undefined') {
                // Total count of dice
                if (resolutionStep === 0) {
                    totalDice = num;
                    nextStep();
                }
                // Allocate to Fickle
                else if (resolutionStep === 1) {
                    // Ensure our number is within the valid total dice, otherwise ignore it
                    if (num > totalDice) {
                        return;
                    }
                    
                    fickleDice = num;
                    flatDice = totalDice - num;
                    nextStep();
                }
                // On results we change the difficulty
                // So not really a dice, but a number the user can press
                else if (resolutionStep === 3) {
                    if (num >= 3 && num <= 6) {
                        difficulty = num;
                        showEle('rollResults', 'difficulty', difficulty);
                        showResults(true);
                    }
                }
                // Otherwise not a dice step
            }
        }
        
        function chooseLuckFickle(answer) {
            luckFickle = answer;
            updateDropdown('luckFickle', luckFickle);
            nextStep();
        }
        
        function useRemoteChanged(newVal) {
            useRemote = newVal;
        }
        
        function difficultyChanged(newVal) {
            difficulty = newVal;
            showResults(true);
        }
        
        function nextStep() {
            changeStep(resolutionStep+1);
        }
        
        function prevStep() {
            changeStep(resolutionStep-1);
        }
        
        function changeStep(newStep) {
            resolutionStep = newStep;
            
            // Reset steps if we're out of bounds
            if (resolutionStep < 0 || resolutionStep > MAX_STEPS) {
                resolutionStep = 0;
            }
            
            // Hide everything first, then show the prompt we need
            hideAllPrompts();
            
            // Total count of dice
            if (resolutionStep === 0) {
                showEle('totalCount', 'totalDice', totalDice);
            }
            // Allocate to Fickle
            else if (resolutionStep === 1) {
                totalDice = getDropdownNum('totalDice', totalDice);
                
                // Fill our dropdown
                var fickleDropdown = document.getElementById('fickleDice');
                if (fickleDropdown) {
                    // Clear our old options
                    while (fickleDropdown.options.length > 0) {                
                        fickleDropdown.remove(0);
                    }
                    
                    if (totalDice > 0) {
                        // Then populate the list with our total dice
                        for (var diceLoop = 1; diceLoop <= totalDice; diceLoop++) {
                            fickleDropdown.add(new Option(diceLoop + ' of ' + totalDice, diceLoop));
                        }
                    }
                    else {
                        fickleDropdown.add(new Option(0));
                    }
                }
                
                // If our old Fickle dice var is out of range, reset it
                if (fickleDice <= 0 || fickleDice > totalDice) {
                    fickleDice = totalDice;
                }
                
                showEle('fickleCount', 'fickleDice', fickleDice);
                outputVar('totalDiceOut', totalDice);
            }
            // Luck dice
            else if (resolutionStep === 2) {
                fickleDice = getDropdownNum('fickleDice', fickleDice);
                flatDice = totalDice - fickleDice;
                
                showEle('luckChoice', 'luckFickle', luckFickle);
            }
            // Roll results
            else if (resolutionStep === 3) {
                luckFickle = getDropdownBoolean('luckFickle', luckFickle);
                
                // Another rare case where we have 0 total dice, 0 Fickle, and the user tried to put Luck to Flat
                // Instead of getting fancy we're just going to reset the choice to Fickle
                if (totalDice === 0 && fickleDice === 0) {
                    luckFickle = true;
                }
                
                showEle('rollResults', 'difficulty', difficulty);
                rollItBaby();
            }
        }
        
        /**
         * Roll the allocated Fickle dice and the Luck Dice if needed
         * This will show the results after
         */
        function rollItBaby() {
            // Reset our successes count and vars
            outputVar('totalSuccesses', '?');
            results = {
                allowUnderdog: true,
                luckDice: -1,
                fickleDice: [],
                flatSuccesses: flatDice
            };
            
            if (!useRemote) {
                for (var handful = 0; handful < fickleDice; handful++) {
                    results.fickleDice.push(D6());
                }
                preShowResults();
            }
            else {
                // Don't show results, instead show the loading animation of...
                //  INTENSE DICE SHAKING
                hideEle('rollResults');
                showEle('shakingDiceWrap');
                
                remoteD6(fickleDice).then(function(rolls) {
                    results.fickleDice = rolls;
                    preShowResults();
                }).catch(function(error) {
                    alertAndUncheckRemote(error);
                }).finally(function() {
                    hideEle('shakingDiceWrap');
                    showEle('rollResults', 'difficulty', difficulty);
                });
            }
        }
        
        function preShowResults() {
            if (luckFickle === true) {
                results.luckDice = D6();
            }
            else {
                results.luckDice = -1;
                results.flatSuccesses += 2;
            }
            
            // If we don't have any explodable dice, just ignore the Underdog bonus
            results.allowUnderdog = results.luckDice >= 6 ? true : false;
            for (var explodeCheck = 0; explodeCheck < results.fickleDice.length; explodeCheck++) {
                if (results.fickleDice[explodeCheck] >= 6) {
                    results.allowUnderdog = true;
                    break;
                }
            }
            
            updateUnderdogButton();
            showResults();
        }
        
        /**
         * Make our dice images and populate the necessary HTML panel
         * The 'silent' flag just stops a console.log from being done
         */
        function showResults(silent) {
            // Update our success message
            var successes = 0;
            for (var check = 0; check < results.fickleDice.length; check++) {
                if (results.fickleDice[check] >= difficulty) {
                    successes++;
                }
            }
            if (luckFickle === true && results.luckDice >= (difficulty-1)) {
                successes++;
            }
            if (successes > 0) {
                successes += results.flatSuccesses;
            }
            outputVar('totalSuccesses', successes);
            
            // Sort our dice results
            results.fickleDice.sort();
            
            var resPanel = document.getElementById('rollPanel');
            if (resPanel) {
                // Loop and add SVG images for our dice
                var html = '';
                for (var loop = 0; loop < results.fickleDice.length; loop++) {
                    html += makeDice(results.fickleDice[loop]);
                }
                
                // Append the Luck dice
                if (luckFickle === true) {
                    html += makeDice(results.luckDice, true);
                }
                
                // Add a note on Flat successes
                html += '<div class="flatMessage">plus ' + flatDice + ' Flat Dice';
                if (luckFickle === false) {
                    html += ' (and Luck Dice)';
                }
                html += '</div>';
                
                resPanel.innerHTML = html;
            }
            
            if (!silent) {
                // Log to the console, in case nerds are reading
                var message = totalDice + ' dice pool, used ' + fickleDice + ' as Fickle (' + results.fickleDice + ')';
                if (luckFickle === true) {
                    message += ' and Luck Dice of ' + results.luckDice;
                }
                message += ' plus ' + results.flatSuccesses + ' Flat';
                if (luckFickle === false) {
                    message += ' (includes Luck Dice)';
                }
                message += ' = ' + successes + ' Successes vs difficulty ' + difficulty;
                console.log(message);
            }
        }
        
        function updateUnderdogButton() {
            // Update our Underdog button
            var underdogButton = document.getElementById('underdogButton');
            if (underdogButton) {
                underdogButton.disabled = !results.allowUnderdog;
            }
        }
        
        function underdogBonus() {
            if (results.allowUnderdog) {
                results.allowUnderdog = false;
                updateUnderdogButton();
                
                var exploded = explodeDice(results.fickleDice, true);
                showResults(true);
            }
        }
        
        function explodeDice(toCheck, firstRun) {
            // Set our Luck Dice as well, but only on the initial run
            var explodingDice = 0;
            if (firstRun && results.luckDice >= 6) {
                explodingDice = 1;
            }
            
            // Check our passed array for explodable targets
            for (var loop = 0; loop < toCheck.length; loop++) {
                if (toCheck[loop] === 6) {
                    explodingDice++;
                }
            }
            
            // If we have dice we should explode, then roll a new D6 for each
            // Note we don't use random.org here, even if useRemote is true, just for simplicity
            if (explodingDice > 0) {
                var newDice = [];
                
                for (var handful = 0; handful < explodingDice; handful++) {
                    newDice.push(D6());
                }
                
                // Update our results list if requested
                results.fickleDice = results.fickleDice.concat(newDice);
                
                // There is a slim change our exploded dice explode again, so recursively check for that
                return explodeDice(newDice);
            }
            
            return results.fickleDice;
        }
    </script>
</head>
<body onload="init()">
    <div id="headerMessage" class="headerBox" style="display: none;">
        Welcome to the <a href="https://horizongamesblog.wordpress.com/fickle-rpg/" target="_blank">Fickle RPG</a> dice roller! Have a few practice throws and good luck!<br/>
        Hotkeys: <b>Number keys</b> for dropdowns, <b>C</b> to continue, <b>B</b> to go back a step, <b>Y</b>/<b>N</b> for Luck Dice going to Fickle, <b>R</b> to re-roll the same setup, <b>U</b> for the Underdog Bonus, <b>C</b> to clear and do a new roll
    </div>
    
    <div class="bottomLeftPanel" title="By default a local random number generator is used, but if you want a slower remote request can be made for truly random numbers">
        <input id="useRemote" type="checkbox" onchange="useRemoteChanged(this.checked)"></input>
        <label for="useRemote">Use random.org (slower)</label>
    </div>
    
    <div class="bottomRightPanel">
        <button onclick="toggleHeaderMessage()" title="Welcome message and learn a few hotkeys"><u>H</u>elp</button>    
    </div>

    <div id="totalCount" class="promptBox">
        <div class="promptHeader">
            <span class="stepNote">1/3</span>
            Dice Pool Size
        </div>
        <div class="promptContent">
            <select id="totalDice" class="bigDropdown">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
            </select>
            <button onclick="nextStep();">&gt; <u>C</u>ontinue</button>
            <br/><br/>
            Total is Attribute + Skill (if applicable) and <b>NOT</b> including Luck Dice
        </div>
    </div>
    
    <div id="fickleCount" class="promptBox" style="display: none;">
        <div class="promptHeader">
            <span class="stepNote">2/3</span>
            Allocate to Fickle
        </div>
        <div class="promptContent">
            <select id="fickleDice" class="bigDropdown">
            </select>
            <button onclick="nextStep();">&gt; <u>C</u>ontinue</button>
            <button onclick="prevStep();"><u>B</u>ack</button>
            <br/><br/>
            Each Fickle dice will be rolled and counts as 1 Success on<br/>4+ (Easy), 5+ (Normal), 6+ (Hard)<br/>
            <br/>
            The rest of the dice will be allocated to Flat.
        </div>
    </div>
    
    <div id="luckChoice" class="promptBox" style="display: none;">
        <div class="promptHeader">
            <span class="stepNote">3/3</span>
            Choose Luck Dice
        </div>
        <div class="promptContent">
            <select id="luckFickle" class="bigDropdown">
                <option value="true">Fickle</option>
                <option value="false">Flat</option>
            </select>
            <button onclick="nextStep();">&#9861; <u>C</u>ontinue</button>
            <button onclick="prevStep();"><u>B</u>ack</button>
            <br/><br/>
            If you choose <b>Fickle</b> then the Luck Dice is one step easier for difficulty (so Normal becomes Easy).<br/>
            <br/>
            Otherwise if you choose <b>Flat</b> then the Luck Dice counts as 2 Successes (if your Fickle roll passes).
        </div>
    </div>
    
    <div id="rollResults" class="centerBox" style="display: none;">
        <center>
            <div class="successMessage">Successes<br/><span id="totalSuccesses" class="successNum"></span></div>
            <br/><br/>
            <select id="difficulty" class="medDropdown" onchange="difficultyChanged(this.value)">
                <option value="3">3+ (Trivial)</option>
                <option value="4">4+ (Easy)</option>
                <option value="5">5+ (Normal)</option>
                <option value="6">6+ (Hard)</option>
            </select>
            <br/><br/>
            <div id="rollPanel" class="rollPanel"></div>
            <br/>
            <button onclick="rollItBaby()" title="Re-roll with the same setup"><u>R</u>e-roll</button>
            <button id="underdogButton" onclick="underdogBonus()" title="Apply the Underdog Bonus (6s explode into a new dice), given to the person who allocated LESS Fickle dice"><u>U</u>nderdog Bonus</button>
            <button onclick="nextStep()" title="Setup an entirely new roll"><u>C</u>ancel</button>
        </center>
    </div>
    
    <div id="shakingDiceWrap" class="shakingDiceWrap" style="display: none;">
        <span class="rollNote">Rolling...</span>
        <div class="shakingDice">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: 256px; width: 256px;"><g class="" transform="translate(0,0)" style="touch-action: none;"><path d="M255.76 44.764c-6.176 0-12.353 1.384-17.137 4.152L85.87 137.276c-9.57 5.536-9.57 14.29 0 19.826l152.753 88.36c9.57 5.536 24.703 5.536 34.272 0l152.753-88.36c9.57-5.535 9.57-14.29 0-19.825l-152.753-88.36c-4.785-2.77-10.96-4.153-17.135-4.153zm-.824 53.11c9.013.097 17.117 2.162 24.31 6.192 4.92 2.758 8.143 5.903 9.666 9.438 1.473 3.507 1.56 8.13.26 13.865l-1.6 5.706c-1.06 4.083-1.28 7.02-.66 8.81.57 1.764 1.983 3.278 4.242 4.544l3.39 1.898-33.235 18.62-3.693-2.067c-4.118-2.306-6.744-4.912-7.883-7.82-1.188-2.935-.99-7.603.594-14.005l1.524-5.748c.887-3.423.973-6.23.26-8.418-.653-2.224-2.134-3.983-4.444-5.277-3.515-1.97-7.726-2.676-12.63-2.123-4.956.526-10.072 2.268-15.35 5.225-4.972 2.785-9.487 6.272-13.55 10.46-4.112 4.162-7.64 8.924-10.587 14.288L171.9 138.21c5.318-5.34 10.543-10.01 15.676-14.013 5.134-4 10.554-7.6 16.262-10.8 14.976-8.39 28.903-13.38 41.78-14.967 3.208-.404 6.315-.59 9.32-.557zm50.757 56.7l26.815 15.024-33.235 18.62-26.816-15.023 33.236-18.62zM75.67 173.84c-5.753-.155-9.664 4.336-9.664 12.28v157.696c0 11.052 7.57 24.163 17.14 29.69l146.93 84.848c9.57 5.526 17.14 1.156 17.14-9.895V290.76c0-11.052-7.57-24.16-17.14-29.688l-146.93-84.847c-2.69-1.555-5.225-2.327-7.476-2.387zm360.773.002c-2.25.06-4.783.83-7.474 2.385l-146.935 84.847c-9.57 5.527-17.14 18.638-17.14 29.69v157.7c0 11.05 7.57 15.418 17.14 9.89L428.97 373.51c9.57-5.527 17.137-18.636 17.137-29.688v-157.7c0-7.942-3.91-12.432-9.664-12.278zm-321.545 63.752c6.553 1.366 12.538 3.038 17.954 5.013 5.415 1.976 10.643 4.417 15.68 7.325 13.213 7.63 23.286 16.324 30.218 26.082 6.932 9.7 10.398 20.046 10.398 31.04 0 5.64-1.055 10.094-3.168 13.364-2.112 3.212-5.714 5.91-10.804 8.094l-5.2 1.92c-3.682 1.442-6.093 2.928-7.23 4.46-1.137 1.472-1.705 3.502-1.705 6.092v3.885l-29.325-16.933v-4.23c0-4.72.892-8.376 2.68-10.97 1.787-2.652 5.552-5.14 11.292-7.467l5.2-2.006c3.087-1.21 5.334-2.732 6.742-4.567 1.46-1.803 2.192-4.028 2.192-6.676 0-4.027-1.3-7.915-3.9-11.66-2.6-3.804-6.227-7.05-10.885-9.74-4.387-2.532-9.126-4.29-14.217-5.272-5.09-1.04-10.398-1.254-15.922-.645v-27.11zm269.54 8.607c1.522 0 2.932.165 4.232.493 6.932 1.696 10.398 8.04 10.398 19.034 0 5.64-1.056 11.314-3.168 17.023-2.112 5.65-5.714 12.507-10.804 20.568l-5.2 7.924c-3.682 5.695-6.093 9.963-7.23 12.807-1.137 2.785-1.705 5.473-1.705 8.063v3.885l-29.325 16.932v-4.23c0-4.72.894-9.41 2.68-14.067 1.79-4.715 5.552-11.55 11.292-20.504l5.2-8.01c3.087-4.776 5.334-8.894 6.742-12.354 1.46-3.492 2.192-6.562 2.192-9.21 0-4.028-1.3-6.414-3.898-7.158-2.6-.8-6.23.142-10.887 2.83-4.387 2.533-9.124 6.25-14.215 11.145-5.09 4.84-10.398 10.752-15.922 17.74v-27.11c6.553-6.2 12.536-11.44 17.95-15.718 5.417-4.278 10.645-7.87 15.68-10.777 10.738-6.2 19.4-9.302 25.99-9.307zm-252.723 94.515l29.326 16.93v30.736l-29.325-16.93v-30.735zm239.246 8.06v30.735l-29.325 16.93v-30.733l29.326-16.932z" fill="#fff" fill-opacity="1"></path></g></svg>
        </div>
    </div>
</body>
</html>
